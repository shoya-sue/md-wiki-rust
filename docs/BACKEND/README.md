# Backend Architecture Documentation

## Overview
このドキュメントでは、バックエンドの構造と各コンポーネントの役割について説明します。バックエンドはRustで実装され、主にAxumフレームワークを使用したWebサーバーとして動作します。

## Directory Structure

```plaintext
backend/
├── src/
│   ├── main.rs           # アプリケーションのエントリーポイント
│   ├── lib.rs            # ライブラリのルートモジュール
│   ├── config.rs         # 設定管理
│   ├── error.rs          # エラー型定義
│   ├── git_ops.rs        # Git操作関連の機能
│   ├── auth/             # 認証関連
│   │   ├── mod.rs        # 認証モジュール定義
│   │   ├── jwt.rs        # JWT認証の実装
│   │   └── middleware.rs # 認証ミドルウェア
│   ├── models/           # データモデル
│   │   ├── mod.rs        # モデルモジュール定義
│   │   ├── user.rs       # ユーザーモデル
│   │   └── document.rs   # ドキュメントモデル
│   ├── db/               # データベース操作
│   │   ├── mod.rs        # データベースモジュール定義
│   │   ├── schema.sql    # SQLiteスキーマ
│   │   └── users.rs      # ユーザーテーブル操作
│   ├── handlers/         # リクエストハンドラ
│   │   ├── auth.rs       # 認証関連ハンドラ
│   │   └── documents.rs  # ドキュメント操作ハンドラ
│   └── routes/           # ルーティング定義
```

## Core Components

### 1. アプリケーションのエントリーポイント (`main.rs`)
- サーバーの初期化と起動
- ルーティングの設定
- ミドルウェアの設定
- データベース接続の確立

### 2. 設定管理 (`config.rs`)
- 環境変数の管理
- アプリケーション設定の読み込み
- データベース接続情報の管理
- JWTシークレットの管理

### 3. エラー処理 (`error.rs`)
- カスタムエラー型の定義
- エラーの変換と処理
- エラーレスポンスの標準化

### 4. Git操作 (`git_ops.rs`)
- Markdownファイルのバージョン管理
- コミット履歴の取得
- 差分の表示
- ブランチ操作

### 5. 認証システム (`auth/`)
- JWTトークンの生成と検証
- ユーザー認証
- 認可制御
- セッション管理

### 6. データモデル (`models/`)
- データ構造の定義
- バリデーションロジック
- データ変換処理
- ビジネスロジック

### 7. データベース操作 (`db/`)
- SQLiteデータベース操作
- クエリビルダー
- マイグレーション管理
- トランザクション処理

### 8. リクエストハンドラ (`handlers/`)
- HTTPリクエストの処理
- ビジネスロジックの実行
- レスポンスの生成
- エラーハンドリング

## データフロー

1. クライアントからのリクエスト
2. 認証ミドルウェアによるトークン検証
3. ルーティングによる適切なハンドラへの振り分け
4. ハンドラでのリクエスト処理
5. モデルを通じたビジネスロジックの実行
6. データベース操作（必要な場合）
7. Git操作（必要な場合）
8. レスポンスの生成と返送

## 主要な機能

### ドキュメント管理
- Markdownファイルの作成・編集・削除
- バージョン管理（Git統合）
- メタデータ管理（SQLite）
- 全文検索

### ユーザー管理
- ユーザー登録・認証
- ロールベースのアクセス制御
- プロファイル管理

### セキュリティ
- JWT認証
- パスワードハッシュ化（Argon2）
- CORS設定
- レート制限

## 依存関係
- axum: Webフレームワーク
- tokio: 非同期ランタイム
- sqlx: データベース操作
- git2: Git操作
- jsonwebtoken: JWT処理
- argon2: パスワードハッシュ化
- serde: シリアライズ/デシリアライズ

## エラー処理戦略
1. カスタムエラー型による型安全なエラー処理
2. Result型を使用した統一的なエラーハンドリング
3. エラーの適切なログ記録
4. クライアントへの適切なエラーメッセージの提供

## セキュリティ考慮事項
1. 適切なパスワードハッシュ化
2. JWTトークンの適切な有効期限設定
3. セキュアなセッション管理
4. SQLインジェクション対策
5. XSS対策
